@using his.ViewModel;
@model PatientViewModel;
@{
    ViewData["Title"] = "Danh sách người bệnh";
    var date = DateTime.Now.AddYears(-10).ToString("yyyy-MM-dd");
    var admissionDate = DateTime.Now.ToString("yyyy-MM-ddTHH:mm");
    var patients = Model.Patients;
    var departments = Model.Departments;
    var emrTypes = Model.EmrTypes;
}

<!-- Breadcrumb -->
<div class="page-header">
    <h3 class="fw-bold mb-3">Người bệnh</h3>
    <ul class="breadcrumbs mb-3">
        <li class="nav-home">
            <a href="/">
                <i class="icon-home"></i>
            </a>
        </li>
        <li class="separator">
            <i class="icon-arrow-right"></i>
        </li>
        <li class="nav-item">
            <a href="/patients">Người bệnh</a>
        </li>
    </ul>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex align-items-center">
                    <h4 class="card-title">Danh sách người bệnh</h4>
                    <button type="button" class="btn btn-primary btnTiepNhan" data-bs-toggle="modal" data-bs-target="#tiepNhanModal">
                        Tiếp Nhận Người Bệnh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="add-row" class="display table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Mã NB</th>
                                <th>Họ tên</th>
                                <th>Ngày sinh</th>
                                <th>Khoa phòng</th>
                                <th>Mã nhập viện/BA</th>
                                <th>Thời gian nhập khoa</th>
                                <th>Giới tính</th>
                                <th>Ngày sinh</th>
                                <th style="width: 10%">Chức năng</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var p in patients)
                            {
                                <tr>
                                    <td>@p.PatientCode</td>
                                    <td>@p.FullName</td>
                                    <td>@p.DateOfBirth.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td>@p.DepartmentName</td>
                                    <td>@p.AdmissionCode</td>
                                    <td>@p.AdmissionDate?.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td>@p.Gender</td>
                                    <td>@p.DateOfBirth.ToString("dd/MM/yyyy")</td>
                                    <td>
                                        <div class="form-button-action">
                                            <button type="button" class="btn btn-link btn-primary btn-lg" onclick="openModalXetNghiem()">Xét nghiệm</button>
                                            <button type="button" class="btn btn-link btn-primary btn-lg">CĐHA</button>
                                            <button type="button" class="btn btn-link btn-primary btn-lg">Kê thuốc</button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="tiepNhanModal" tabindex="-1" aria-labelledby="tiepNhanModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="tiepNhanModalLabel">Tiếp Nhận Người Bệnh</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <form id="formTiepNhan">
                <div class="modal-body">
                    <input type="hidden" id="tenkhoa" name="tenkhoa" />
                    <input type="hidden" id="loaiba" name="loaiba" />
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Mã Bệnh Nhân</label>
                            <input type="text" class="form-control" id="mabenhnhan" name="mabenhnhan" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Họ và Tên</label>
                            <input type="text" class="form-control" id="hoten" name="hoten" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Ngày Sinh</label>
                            <input type="date" class="form-control" id="ngaysinh" name="ngaysinh" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Giới Tính</label>
                            <select class="form-select" id="gioitinh" name="gioitinh">
                                <option value="Nam">Nam</option>
                                <option value="Nữ">Nữ</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">CMND/CCCD</label>
                            <input type="text" class="form-control" id="cccdso" name="cccdso" />
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Địa Chỉ</label>
                            <input type="text" class="form-control" id="diachi" name="diachi" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Mã BHYT</label>
                            <input type="text" class="form-control" id="mabhyt" name="mabhyt" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Người Nhà Liên Hệ</label>
                            <input type="text" class="form-control" id="hotennguoithan" name="hotennguoithan" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">SĐT Người Nhà</label>
                            <input type="text" class="form-control" id="sodienthoainguoithan" name="sodienthoainguoithan" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Khoa Điều Trị</label>
                            <select class="form-select" id="makhoa" name="makhoa">
                                <option value="">-- Chọn khoa --</option>
                                @foreach (var department in departments)
                                {
                                    <option value="@department.Code">@department.Value</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Loại bệnh án</label>
                            <select class="form-select" id="maloaiba" name="maloaiba">
                                <option value="">-- Chọn bệnh án --</option>
                                @foreach (var emr in emrTypes)
                                {
                                    <option value="@emr.Code">@emr.Value</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Lý Do Vào Viện</label>
                            <input type="text" class="form-control" id="lydovaovien" name="lydovaovien" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Chẩn Đoán Vào Viện</label>
                            <input type="text" class="form-control" id="chandoanvaovien" name="chandoanvaovien" />
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Nhập Viện/Nhập Khoa</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="modalXetNghiem" class="modal-overlay">
    <div class="modal">
        <span class="close" onclick="closeModalXetNghiem()">&times;</span>
        <h2>Chỉ Định Xét Nghiệm</h2>

        <form action="/patients/create" method="post" id="xetNghiemForm">
            <label for="maBenhNhan">Thông tin người bệnh</label>
            Tên người bệnh: <b>Nguyễn Văn A</b> Ngày sinh: <b>01/01/1990</b> Giới tính: <b>Nam</b><br />
            Mã người bệnh: <b>BN001</b>
            Mã nhập khoa: <b>BA001</b> Mã khoa: <b>KH001</b><br /> Ngày nhập khoa: <b>01/01/2023</b> Mã BA: <b>BA001</b><br />
            Thông tin hành chính: <br />
            CCCD: <b>123456789</b> Ngày cấp: <b>01/01/2023</b> Số điện thoại: <b>0123456789</b> Địa chỉ: <b>123 Đường ABC, TP.HCM</b><br />
            <br>
            <label for="xetNghiem">Chọn Xét Nghiệm:</label>
            <select id="xetNghiem" name="DanhSachXetNghiem[]" multiple>
                <option value="XN001">Huyết học</option>
                <option value="XN002">Sinh hóa máu</option>
                <option value="XN003">Nước tiểu</option>
                <option value="XN004">Chức năng gan</option>
                <option value="XN005">CRP định lượng</option>
            </select>

            <label for="ghiChu">Ghi chú:</label>
            <textarea id="ghiChu" name="GhiChu" rows="2"></textarea>

            <div class="actions">
                <button type="button" class="btn-close" onclick="closeModalXetNghiem()"><i class="fa-solid fa-xmark"></i> Huỷ</button>
                <button type="submit" class="btn-submit"><i class="fa-solid fa-download"></i> Lưu chỉ định</button>
            </div>
        </form>
    </div>
</div>


@section Scripts
{
    <script src="~/js/patient.js"></script>
}

