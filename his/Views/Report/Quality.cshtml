@{
    Layout = "_Layout";
    ViewData["Title"] = "Báo cáo sai số | Onelab";
}

<div class="container-fluid">
    <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
        <div>
            <h3 class="fw-bold mb-3">Báo cáo Sai số Xét nghiệm</h3>
        </div>
        <div class="ms-md-auto py-2 py-md-0">
            <button class="btn btn-label-info btn-round me-2" onclick="exportExcel()">Xuất báo báo</button>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <label for="timeFilter" class="form-label">Lọc theo thời gian</label>
            <select id="timeFilter" class="form-select">
                <option value="1">1 tháng gần nhất</option>
                <option value="3">3 tháng</option>
                <option value="6">6 tháng</option>
            </select>
        </div>
    </div>

    <div class="row g-4">
        <!-- Sai số mẫu đầu/cuối -->
        <div class="col-md-6">
            <div class="card p-3">
                <h6 class="fw-bold">Sai số mẫu đầu/cuối</h6>
                <div class="chart-container">
                    <canvas id="sampleErrorChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Sai số nhập liệu -->
        <div class="col-md-6">
            <div class="card p-3">
                <h6 class="fw-bold">Sai số do nhập liệu</h6>
                <div class="chart-container">
                    <canvas id="entryErrorChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Phân tích AI -->
        <div class="col-12">
            <div class="card p-4 bg-light">
                <h6 class="fw-bold">🧠 AI cảnh báo & Gợi ý theo ICD-10</h6>
                <p>
                    Cảnh báo: Tăng tỉ lệ sai số mẫu đầu/cuối (>15%) có thể liên quan đến quy trình bảo quản hoặc sai sót thao tác đầu/cuối tại phòng lấy mẫu. Đề nghị kiểm tra điều kiện bảo quản, quy trình lấy mẫu.<br>
                    ICD-10 liên quan: R89.9 (Phát hiện bất thường không xác định trong mẫu), Z03.89 (Quan sát và đánh giá bệnh lý không xác định).
                </p>
            </div>
        </div>
    </div>
</div>

@section Scripts
{
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Biểu đồ sai số mẫu đầu/cuối
        new Chart(document.getElementById('sampleErrorChart'), {
          type: 'bar',
          data: {
            labels: ['T1', 'T2', 'T3', 'T4'],
            datasets: [{
              label: '% Sai số',
              data: [12, 18, 22, 14],
              backgroundColor: '#dc3545'
            }]
          },
          options: { responsive: true }
        });

        // Biểu đồ sai số nhập liệu
        new Chart(document.getElementById('entryErrorChart'), {
          type: 'bar',
          data: {
            labels: ['T1', 'T2', 'T3', 'T4'],
            datasets: [{
              label: 'Số lỗi',
              data: [8, 5, 7, 6],
              backgroundColor: '#ffc107'
            }]
          },
          options: { responsive: true }
        });

                function exportExcel() {
          const wb = XLSX.utils.book_new();

          // Dữ liệu giả lập
          const sampleErrors = [
            ['Tháng', 'Sai số mẫu đầu/cuối (%)'],
            ['T1', 12],
            ['T2', 18],
            ['T3', 22],
            ['T4', 14]
          ];

          const entryErrors = [
            ['Tháng', 'Sai số nhập liệu'],
            ['T1', 8],
            ['T2', 5],
            ['T3', 7],
            ['T4', 6]
          ];

          const ws1 = XLSX.utils.aoa_to_sheet(sampleErrors);
          const ws2 = XLSX.utils.aoa_to_sheet(entryErrors);

          XLSX.utils.book_append_sheet(wb, ws1, 'Sai số mẫu');
          XLSX.utils.book_append_sheet(wb, ws2, 'Sai số nhập liệu');

          XLSX.writeFile(wb, 'baocao_saiso_onelab.xlsx');
        }
    </script>
}

